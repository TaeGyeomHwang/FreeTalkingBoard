<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.css" />
</head>

<!-- 파일 첨부 style -->
<style>
    .uploadResult {
        width: 100%;
        background-color: aliceblue;
    }
    .uploadResult ul {
        display: flex;
        flex-flow: row;
        justify-content: left;
        align-items: center;
    }
    .uploadResult ul li {
        display: inline;
        margin-right: 10px;
        position: relative;
        padding-right: 20px;
    }
    .uploadResult ul li img{
        width: 20px;
    }
</style>

<!-- 취소 버튼 클릭 시 메인화면으로 돌아가는 스크립트 -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cancelBtn = document.getElementById('cancel-btn');

        cancelBtn.addEventListener('click', function () {
            window.location.href = '/';             //Redirect to boards page
        });
    });
</script>
<body>
<form>
    <div class="container mt-5">
        <div class="row">
            <div class="col-lg-8">
                <article>
                    <!-- 아이디 정보 저장 -->
                    <input type="hidden" id="board-id" th:value="${board.id}">
                    <header class="mb-4">
                        <input type="text" class="form-control" placeholder="제목" id="title" th:value="${board.title}">
                    </header>
                    <section class="mb-5">
                        <div id='ui'></div>
                    </section>

                    <!-- 파일 첨부 -->
                    <div class="uploadDiv">
                        <input type="file" name="uploadFiles" id="file-upload" multiple>
                    </div>
                    <div class="uploadResult">
                        <ul id="file-list">
                        </ul>
                    </div>

                    <!-- 해시태그 -->
                    <div class="mb-3">
                        <div>
                            <input type="text" id="hashtags" class="form-control" placeholder="해시태그를 추가해보세요.">
                            <div id="hashtags-container"></div>
                            <input type="hidden" id="hashtags-hidden" th:field="*{hashtag.id}" />
                        </div>
                    </div>
                    <!-- id가 있을 때는 [수정] 버튼을, 없을 때는 [등록] 버튼이 보이게 함 -->
                    <button th:if="${board.id} != null" type="button" id="modify-btn" class="btn btn-primary btn-sm">수정하기</button>
                    <button th:if="${board.id} == null" type="button" id="create-btn" class="btn btn-primary btn-sm">등록하기</button>
                    <button type="button" id="cancel-btn" class="btn btn-primary btn-sm">취소하기</button>
                </article>
            </div>
        </div>
    </div>
</form>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<!-- 글 content 스크립트 -->
<script>
    const editor = new toastui.Editor({
        el: document.querySelector('#ui'),
        previewStyle: 'vertical',
        initialEditType: 'wysiwyg',
        height: '500px',
        placeholder: '내용을 입력해주세요.',
        /* start of hooks */
        hooks: {
            async addImageBlobHook(blob, callback) { // 이미지 업로드 로직 커스텀
                try {
                    /*
                 * 1. 에디터에 업로드한 이미지를 FormData 객체에 저장
                 *    (이때, 컨트롤러 uploadEditorImage 메서드의 파라미터인 'image'와 formData에 append 하는 key('image')값은 동일해야 함)
                 */
                    const formData = new FormData();
                    formData.append('image', blob);

                    // 2. FileApiController - uploadEditorImage 메서드 호출
                    const response = await fetch('/tui-editor/image-upload', {
                        method: 'POST',
                        body: formData,
                    });

                    // 3. 컨트롤러에서 전달받은 디스크에 저장된 파일명
                    const filename = await response.text();
                    console.log('서버에 저장된 파일명 : ', filename);

                    // 4. addImageBlobHook의 callback 함수를 통해, 디스크에 저장된 이미지를 에디터에 렌더링
                    const imageUrl = `/tui-editor/image-print?filename=${filename}`;
                    callback(imageUrl, 'image alt attribute');

                } catch (error) {
                    console.error('업로드 실패 : ', error);
                }
            }
        }
    });
    editor.setHTML(document.getElementById('article-content').value);
</script>

<!-- 파일 첨부 스크립트 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fileUpload = document.getElementById('file-upload');
        const fileList = document.getElementById('file-list');
        let selectedFiles = [];

        fileUpload.addEventListener('change', function() {
            const files = fileUpload.files;
            fileList.innerHTML = ''; // Clear the list first
            selectedFiles = Array.from(files); // Update selected files

            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.textContent = file.name;

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.classList.add('remove-btn');
                removeBtn.addEventListener('click', function() {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                });

                li.appendChild(removeBtn);
                fileList.appendChild(li);
            });
        });

        function updateFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.textContent = file.name;

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'x';
                removeBtn.classList.add('remove-btn');
                removeBtn.addEventListener('click', function() {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                });

                li.appendChild(removeBtn);
                fileList.appendChild(li);
            });
        }
    });
</script>

<!-- 해시태그 스크립트 -->
<script>
    const hashtagsInput = document.getElementById("hashtags");
    const hashtagsContainer = document.getElementById("hashtags-container");
    const hiddenHashtagsInput = document.getElementById("hashtags-hidden");

    let hashtags = [];

    function addHashtag(tag) {
        tag = tag.replace(/[\[\]]/g, '').trim();
        if(tag && !hashtags.includes(tag)) {
            const span = document.createElement("span");
            span.innerText = "#" + tag + " ";
            span.classList.add("hashtag");

            const removeButton = document.createElement("button");
            removeButton.innerText = "x";
            removeButton.classList.add("remove-button");
            removeButton.addEventListener("click", () => {
                hashtagsContainer.removeChild(span);
                hashtags = hashtags.filter((hashtag) => hashtag !== tag);
                hiddenHashtagsInput.value = hashtags.join(",");
            });

            span.appendChild(removeButton);
            hashtagsContainer.appendChild(span);
            hashtags.push(tag);
            hiddenHashtagsInput.value = hashtags.join(",");
        }
    }

    hashtagsInput.addEventListener("keydown", (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            const tag = hashtagsInput.value.trim();
            if (tag) {
                addHashtag(tag);
                hashtagsInput.value = "";
            }
        }
    });
</script>
</body>
</html>